<%- include("../../views/partials/user/header") %>

<style>
    body {
  font-family: 'Poppins', sans-serif;
  background-color: #F8F8F8;
  margin: 0;
}
    :root {
       --primary:#FF3F6c;
       --primary-dark: #FF3F6C;
       --gray-50: #F9FAFB;
       --gray-100: #F3F4F6;
       --gray-200: #E5E7EB;
       --gray-300: #D1D5DB;
       --gray-600: #4B5563;
       --gray-700: #374151;
       --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
       --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
   }

   * {
       margin: 0;
       padding: 0;
       box-sizing: border-box;
   }

   body {
   
       background-color: var(--gray-50);
       color: var(--gray-700);
       line-height: 1.5;
     
   }

   /* Modern Checkout Header */
   .checkout-progress {
       background: white;
       padding: 2rem 0;
       border-bottom: 1px solid var(--gray-200);
       margin-bottom: 2rem;
   }

   .progress-wrapper {
       max-width: 1000px;
       margin: 0 auto;
       padding: 0 2rem;
       position: relative;
   }

   .progress-line {
       position: absolute;
       top: 24px;
       left: 50px;
       right: 50px;
       height: 2px;
       background: var(--gray-200);
       z-index: 1;
   }

   .progress-line-fill {
       position: absolute;
       top: 0;
       left: 0;
       height: 100%;
       background: var(--primary);
       transition: width 0.3s ease;
       width: 50%;
   }

   .steps {
       display: flex;
       justify-content: space-between;
       position: relative;
       z-index: 2;
   }

   .step {
       display: flex;
       flex-direction: column;
       align-items: center;
       gap: 0.75rem;
       width: 120px;
   }

   .step-icon {
       width: 48px;
       height: 48px;
       border-radius: 50%;
       background: white;
       border: 2px solid var(--gray-200);
       display: flex;
       align-items: center;
       justify-content: center;
       font-weight: 500;
       transition: all 0.3s ease;
       color: var(--gray-600);
   }

   .step.active .step-icon {
       border-color: var(--primary);
       color: var(--primary);
       background: white;
   }

   .step.completed .step-icon {
       background: var(--primary);
       border-color: var(--primary);
       color: white;
   }

   .step-label {
       font-size: 0.875rem;
       font-weight: 500;
       color: var(--gray-600);
       text-align: center;
   }

   .step.active .step-label {
       color: var(--primary);
   }

   /* Main Checkout Container */
   .checkout-container {
       max-width: 1200px;
       margin: 0 auto;
       padding: 0 2rem;
   }

   .checkout-grid {
       display: grid;
       grid-template-columns: 1.8fr 1fr;
       gap: 1.5rem;
       max-width: 1100px;
       margin: 0 auto;
   }

   .section-title {
       font-size: 1.25rem;
       font-weight: 600;
       color: var(--gray-700);
       margin-bottom: 1rem;
       display: flex;
       align-items: center;
       gap: 0.5rem;
   }

   .addresses {
       display: grid;
       gap: 0.75rem;
       margin-bottom: 2rem;
   }

   .address-text {
       color: var(--gray-600);
       line-height: 1.4;
   }

   /* Address Cards */
   .address-card {
       background: white;
       border: 1px solid var(--gray-200);
       border-radius: 8px;
       padding: 1rem;
       display: flex;
       align-items: flex-start;
       gap: 0.75rem;
       cursor: pointer;
       transition: all 0.2s ease;
   }

   .address-card:hover {
       border-color: var(--primary);
       background-color: var(--gray-50);
   }

   .address-card input[type="radio"] {
       width: 18px;
       height: 18px;
       margin-top: 0.25rem;
       accent-color: var(--primary);
       cursor: pointer;
   }

   .address-card input[type="radio"]:checked + .address-details {
       color: var(--primary);
   }

   .address-card input[type="radio"]:checked + .address-details .address-name {
       color: var(--primary);
   }

   .address-details {
       flex: 1;
       font-size: 0.9375rem;
   }

   .address-name {
       font-weight: 600;
       margin-bottom: 0.25rem;
       color: var(--gray-700);
   }

   .products {
       display: grid;
       gap: 0.75rem;
   }

   /* Product Cards */
   .product-card {
       background: white;
       border: 1px solid var(--gray-200);
       border-radius: 8px;
       padding: 0.875rem;
       display: flex;
       align-items: center;
       gap: 1rem;
   }

   .product-details {
       flex: 1;
   }

   .product-price {
       font-size: 1rem;
       font-weight: 600;
       color: var(--gray-700);
   }

   .product-name {
       font-size: 0.9375rem;
       font-weight: 500;
       color: var(--gray-700);
       margin-bottom: 0.25rem;
   }

   .product-image {
       width: 80px;
       height: 80px;
       border-radius: 6px;
       object-fit: cover;
       background-color: var(--gray-50);
   }

   .product-info {
       flex: 1;
       display: flex;
       justify-content: space-between;
       align-items: center;
       gap: 1rem;
   }

   .product-info h3 {
       font-size: 1rem;
       font-weight: 500;
       margin-bottom: 0.5rem;
   }

   /* Order Summary */
   .order-summary {
       background: white;
       border: 1px solid var(--gray-200);
       border-radius: 8px;
       padding: 1.25rem;
       position: sticky;
       top: 2rem;
   }

   .summary-row {
       display: flex;
       justify-content: space-between;
       padding: 0.75rem 0;
       color: var(--gray-600);
   }

   .summary-total {
       border-top: 1px solid var(--gray-200);
       margin-top: 1rem;
       padding-top: 1rem;
       font-weight: 600;
       color: var(--gray-700);
   }

   .continue-btn {
       background: var(--primary);
       color: white;
       border: none;
       border-radius: 8px;
       padding: 1rem;
       width: 100%;
       font-weight: 500;
       margin-top: 1.5rem;
       cursor: pointer;
       transition: all 0.2s ease;
   }

   .continue-btn:hover {
       background: var(--primary-dark);
       transform: translateY(-1px);
   }

   @media (max-width: 768px) {
       .checkout-grid {
           grid-template-columns: 1fr;
           gap: 1rem;
           padding: 1rem;
       }

       .product-info {
           flex-direction: column;
           align-items: flex-start;
       }
   }

   @media (max-width: 768px) {
       .checkout-grid {
           grid-template-columns: 1fr;
       }

       .progress-wrapper {
           padding: 0 1rem;
       }

       .step {
           width: auto;
       }

       .step-label {
           font-size: 0.75rem;
       }

       .step-icon {
           width: 40px;
           height: 40px;
       }

       .checkout-container {
           padding: 0 1rem;
       }
   }





   /* header section */


   .checkout-header {
       background: white;
       padding: 2rem 1rem;
       box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
       margin-bottom: 2rem;
       font-family: 'Inter', system-ui, -apple-system, sans-serif;
   }

   .progress-container {
       max-width: 800px;
       margin: 0 auto;
       position: relative;
       padding: 0 1rem;
   }

   .progress-bar {
       position: absolute;
       top: 50%;
       left: 0;
       transform: translateY(-50%);
       height: 3px;
       width: 100%;
       background: #f0f0f0;
       z-index: 1;
   }

   .progress-bar-fill {
       position: absolute;
       top: 0;
       left: 0;
       height: 100%;
       background:#14CAD8;
       transition: width 0.3s ease;
       width: 50%; /* Adjust based on current step */
   }

   .steps-container {
       position: relative;
       display: flex;
       justify-content: space-between;
       z-index: 2;
   }

   .step {
       display: flex;
       flex-direction: column;
       align-items: center;
       gap: 0.5rem;
   }

   .step-circle {
       width: 40px;
       height: 40px;
       border-radius: 50%;
       background: white;
       border: 2px solid #E5E7EB;
       display: flex;
       align-items: center;
       justify-content: center;
       font-weight: 500;
       transition: all 0.3s ease;
   }

   .step.active .step-circle {
       border-color: #14CAD8;
       color: #14CAD8;
   }

   .step.completed .step-circle {
       background: #14CAD8;
       border-color: #14CAD8;
       color: white;
   }

   .step-label {
       font-size: 0.875rem;
       font-weight: 500;
       color: #6B7280;
   }

   .step.active .step-label {
       color: #14CAD8;
   }

   .step.completed .step-label {
       color:  #14CAD8;
   }

   @media (max-width: 640px) {
       .step-label {
           font-size: 0.75rem;
       }
       
       .step-circle {
           width: 32px;
           height: 32px;
       }
   }

   .footer-div {
       margin-top: 60px;
   }


   /* coupon */

   .coupon-container {
margin: 1rem 0 2rem 0;
}

.coupon-form {
margin-top: 1rem;
}

.coupon-input-group {
display: flex;
gap: 0.5rem;
}

.coupon-input {
flex: 1;
padding: 0.75rem 1rem;
border: 1px solid #e2e8f0;
border-radius: 0.5rem;
font-size: 0.875rem;
}

.apply-coupon, .remove-coupon {
padding: 0.75rem 1.5rem;
background-color: #FF3F6C;
color: white;
border: none;
border-radius: 0.5rem;
font-size: 0.875rem;
cursor: pointer;
transition: background-color 0.2s;
}

.apply-coupon:hover, .remove-coupon:hover {
background-color: #FF3F6C;
}

.remove-coupon {
background: none;
color: #FF3F6C;
text-decoration: underline;
padding: 0;
margin-left: 0.5rem;
}

.remove-coupon:hover {
background: none;
color:  #FF3F6C;
}

.coupon-success, .coupon-error {
display: flex;
align-items: center;
gap: 0.5rem;
padding: 0.75rem 1rem;
border-radius: 0.5rem;
margin-top: 1rem;
font-size: 0.875rem;
}

.coupon-success {
background-color: #f0fdf4;
border: 1px solid #bbf7d0;
color: #166534;
}

.coupon-error {
background-color: #fef2f2;
border: 1px solid #fecaca;
color: #991b1b;
}

.coupon-success svg {
stroke: #166534;
}

.coupon-error svg {
stroke: #991b1b;
}

.dis-coupon {
margin-left: 137px;
}

</style>
</head>
<body>



<!-- header -->

<div class="checkout-header">
   <div class="progress-container">
       <div class="progress-bar">
           <div class="progress-bar-fill"></div>
       </div>
       <div class="steps-container">
           <% 
           const steps = [
               { id: 1, label: 'Cart', status: 'completed' },
               { id: 2, label: 'Shipping', status: 'active' },
               { id: 3, label: 'Payment', status: 'pending' },
               { id: 4, label: 'Confirmation', status: 'pending' }
           ];
           %>
           <% steps.forEach(step => { %>
               <div class="step <%= step.status %>">
                   <div class="step-circle">
                       <% if (step.status === 'completed') { %>
                           ✓
                       <% } else { %>
                           <%= step.id %>
                       <% } %>
                   </div>
                   <span class="step-label"><%= step.label %></span>
               </div>
           <% }); %>
       </div>
   </div>
</div>



<!-- header section end -->

<div class="checkout-container">
   <div class="checkout-grid">
       <!-- Left Column -->
       <div class="main-content">
           <h2 class="section-title">
               <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                   <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                   <polyline points="9 22 9 12 15 12 15 22"></polyline>
               </svg>
               Select Delivery Address
           </h2>
           <div class="addresses">
               <% addresses.forEach(function(addressDoc) { %>
                   <% addressDoc.address.forEach(function(address) { %>
                       <label class="address-card" for="address-<%= address._id %>">
                           <input type="radio" name="address" id="address-<%= address._id %>">
                           <div class="address-details">
                               <div class="address-name"><%= address.name %></div>
                               <div class="address-text">
                                   <%= address.street %> <%= address.city %>, <%= address.pincode %>
                               </div>
                           </div>
                       </label>
                   <% }); %>
               <% }); %>
               <a href="/myAddress" class="inline-block px-6 py-3 bg-blue-600 text-secondary font-semibold text-lg rounded-lg shadow-md transition duration-300 hover:bg-blue-700 hover:shadow-lg">
                ➕ Add New Address
            </a>
           </div>

           <!-- coupon -->

           <h2 class="section-title">
               <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                   <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z" />
               </svg>
               Apply Coupon
           </h2>
           
           <div class="coupon-container">
               <% if (locals.couponApplied) { %>
                   <div class="coupon-success">
                       <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                           <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                           <polyline points="22 4 12 14.01 9 11.01"></polyline>
                       </svg>
                       <span>Coupon "<%= couponCode %>" applied successfully!</span>
                       <form action="/remove-coupon" method="POST" class="remove-coupon-form">
                           <button type="submit" class="remove-coupon">Remove</button>
                       </form>
                   </div>
               <% } else { %>
          
                       <div class="coupon-input-group">
                           <input 
                               type="text" 
                               name="couponCode" 
                               id="couponCode"
                               placeholder="Enter coupon code"
                               class="coupon-input"
                               required
                           >
                           <button id="apply-coupon" class="apply-coupon" onclick="applyCoupon('<%= total.toFixed(2) %>')">Apply</button>
                       </div>
                   <% if (locals.couponError) { %>
                       <div class="coupon-error">
                           <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                               <circle cx="12" cy="12" r="10"></circle>
                               <line x1="12" y1="8" x2="12" y2="12"></line>
                               <line x1="12" y1="16" x2="12.01" y2="16"></line>
                           </svg>
                           <span><%= couponError %></span>
                       </div>
                   <% } %>
               <% } %>
           </div>
           <!-- coupon end -->

           <h2 class="section-title">
               <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                   <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path>
                   <line x1="3" y1="6" x2="21" y2="6"></line>
                   <path d="M16 10a4 4 0 0 1-8 0"></path>
               </svg>
               Order Items
           </h2>

           <div class="products">
               <% products.forEach(function(product) { %>
                   <div class="product-card">
                       <img class="product-image" src="/uploads/product-images/<%= product.productImage%>" alt="<%= product.productName %>">
                       <div class="product-info">
                           <div class="product-details">
                               <div class="product-name"><%= product.productName %></div>
                           </div>
                           <div class="product-quantity">
                               <strong>Quantity:</strong> <%= product.quantity %>
                           </div>
                           <div class="product-price">₹<%= product.salePrice%></div>
                       </div>
                   </div>
               <% }); %>
           </div>
           
       </div>

       <!-- Right Column -->
       <div class="sidebar">
           <div class="order-summary">
               <h2 class="section-title">Order Summary</h2>
               <div class="summary-row">
                   <span>Subtotal</span>
                   <span><%=subtotal%></span>
               </div>
               <div class="summary-row">
                   <span>Delivery</span>
                   <span><%=delivery%></span>
               </div>
               <div class="summary-row" id="coupon-discount" style="display: none;">
                   <span>Coupon Discount</span>
                   <span class="dis-coupon"></span>
               </div>
               <div class="summary-row">
                   <span>Discount</span>
                   <span id="discount-price"><%=discount%></span>
               </div>
               <div class="summary-row summary-total">
                   <span>Total</span>
                   <span id="total-amount"><%=total%></span>
               </div>
               <button class="continue-btn" id="continue-btn" >Continue to Payment</button>
           </div>
       </div>
   </div>
</div>




<script>

async function applyCoupon(productPrice) {
    const couponCode = document.getElementById('couponCode').value;

    const response = await fetch('/apply-coupon', {
        method: 'POST',
        headers: {
            'Content-type': 'application/json'
        },
        body: JSON.stringify({ couponCode, productPrice })
    });

    const result = await response.json();

    if (result.success) {
        Swal.fire({
            icon: 'success',
            title: 'Success!',
            text: 'Coupon applied successfully!',
            showConfirmButton: false,
            timer: 2000
        }).then(() => {
            console.log("It's coming here in the successful coupon.");

            const totalAmountElement = document.getElementById('total-amount');
            let totalAmount = parseFloat(totalAmountElement.textContent.replace('₹', '').trim());

            if (isNaN(totalAmount)) {
                console.error("Error: Invalid total amount format.");
                return;
            }

            const offerPrice = result.offerPrice;
            console.log('Offer price for coupon:', offerPrice);

            totalAmountElement.textContent = `₹${(totalAmount - offerPrice).toFixed(2)}`;

            const couponDiscountElement = document.getElementById('coupon-discount');
            if (couponDiscountElement) {
                const discountValueElement = couponDiscountElement.querySelector('span:last-child');
                if (discountValueElement) {
                    couponDiscountElement.style.display = 'block';
                    discountValueElement.textContent = `-₹${offerPrice.toFixed(2)}`;
                }
            }
        });
        return;
    }

    Swal.fire({
        icon: 'error',
        title: 'Oops...',
        text: 'Coupon not found! Try again',
        confirmButtonColor: '#d33'
    });
}

const continueBtn = document.getElementById('continue-btn');

continueBtn.addEventListener('click', (e) => {
    e.preventDefault();

    const selectedAddress = document.querySelector('input[name="address"]:checked');

    if (!selectedAddress) {
        alert('Please select an address before proceeding.');
        return;
    }

    const addressId = selectedAddress.id.replace('address-', '');
    window.location.href = `/payment?id=${addressId}`;
});



</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
















<%- include("../../views/partials/user/footer") %>




