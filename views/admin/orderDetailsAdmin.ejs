<%- include("../../views/partials/admin/header") %>

<head>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        /* General Styling */
        body {
            background-color: #f9f9fb;
            color: #333;
        }

        h2 {
            color: #333;
        }

        /* Card Styling */
        .order-details, .shipping-address, .order-items {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            margin-top: 5px;
        }

        .order-items .item-card {
            background-color: #fff0f6;
            border-left: 5px solid #6b7280;
        }

        .order-items .item-card:hover {
            box-shadow: 0 4px 8px rgba(97, 94, 95, 0.2);
        }

        /* Label and Value Styling */
        .label {
            color: black;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .value {
            color:  #6b7280;
            font-size: 1.1rem;
            font-weight: 600;
        }

        /* Button Styling */
        button {
            background-color:#6b7280;
            border: none;
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: 0.3s;
        }

        button:hover {
            background-color:#6b7280;
        }

        /* Dropdown Styling */
        select {
            border: 1px solid  #6b7280;
            padding: 5px;
            border-radius: 5px;
            background-color: #fff;
            color: #333;
        }

        select:focus {
            border-color:  #6b7280;
        }

        /* Return Request Section */
        .return-request-section {
            background-color: #fff5f8;
            border-left: 5px solid#6b7280;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Order Details</h1>
        <div class="order-grid">
            <!-- Order Details -->
            <div class="order-details">
                <div class="order-meta">
                    <div class="meta-item">
                        <span class="label">Order ID:</span>
                        <span class="value"><%= order.orderId %></span>
                    </div>
                    <div class="meta-item">
                        <span class="label">Total Amount:</span>
                        <span class="value">₹<%= order.finalAmount %></span>
                    </div>
                    <div class="meta-item">
                        <span class="label">Payment Method:</span>
                        <span class="value"><%= order.paymentMethod %></span>
                    </div>
                    <div class="meta-item">
                        <span class="label">Order Date:</span>
                        <span class="value"><%= new Date(order.createdOn).toLocaleDateString() %></span>
                    </div>
                    <div class="meta-item">
                        <span class="label">Status:</span>
                        <select id="status-<%= order.orderId %>" onchange="updateStatus('<%= order.orderId %>')"  <%= order.status === 'Delivered' ? 'disabled' : '' %>>
                            <option value="Pending" <%= order.status === 'Pending' ? 'selected' : '' %>>Pending</option>
                            <option value="Processing" <%= order.status === 'Processing' ? 'selected' : '' %>>Processing</option>
                            <option value="Shipped" <%= order.status === 'Shipped' ? 'selected' : '' %>>Shipped</option>
                            <option value="Delivered" <%= order.status === 'Delivered' ? 'selected' : '' %>>Delivered</option>
                            <option value="Cancelled" <%= order.status === 'Cancelled' ? 'selected' : '' %>>Cancelled</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Shipping Address -->
            <div class="shipping-address">
                <h2>Shipping Address</h2>
                <p><strong>Name:</strong> <%= order.address.name %></p>
                <p><strong>City:</strong> <%= order.address.city %>, <%= order.address.state %> - <%= order.address.pincode %></p>
                <p><strong>Phone:</strong> <%= order.address.phone %></p>
            </div>
        </div>

        <!-- Order Items -->
        <div class="order-items">
            <h2>Order Items</h2>
            <% order.orderItems.forEach(item => { %>
                <div class="item-card">
                    <h3>Product ID: <%= item.product %></h3>
                    <p class="label">Quantity: <%= item.quantity %></p>
                    <p class="label">Price per Unit: ₹<%= item.price %></p>
                    
                    <% if (item.returnRequest?.status === 'Pending') { %>
                        <div class="return-request-section">
                            <h4>Return Request Details</h4>
                            <p><strong>Return Reason:</strong> <%= item.returnRequest.reason %></p>
                            <button onclick="handleReturn('<%= order.orderId %>', '<%= item.product._id %>', 'Approved')">Approve</button>
                            <button onclick="handleReturn('<%= order.orderId %>', '<%= item.product._id %>', 'Rejected')">Reject</button>
                        </div>
                    <% } %>
                </div>
            <% }) %>
        </div>
    </div>
</body>

<script>
    function updateStatus(itemId) {
        const status = document.getElementById(`status-${itemId}`).value;
        fetch('/admin/changeStatus', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ itemId, status })
        })
        .then(response => response.json())
        .then(data => {
            Swal.fire({
                icon: data.success ? 'success' : 'error',
                title: data.success ? 'Success!' : 'Oops!',
                text: data.message || 'Something went wrong.',
                confirmButtonText: 'OK'
            }).then(() => location.reload());
        })
        .catch(error => Swal.fire({ icon: 'error', title: 'Error!', text: 'Failed to update order status.' }));
    }
</script>

<%- include("../../views/partials/admin/footer") %>

